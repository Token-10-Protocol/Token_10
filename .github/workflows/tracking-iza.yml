name: "ğŸ‘ï¸ Tracking IZA - Mapa de Comunidad"

on:
  push:
  watch:
  fork:
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]

permissions:
  contents: write

jobs:
  mapear-comunidad:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ BAJAR CÃ“DIGO
        uses: actions/checkout@v3

      - name: ğŸ”§ INSTALAR HERRAMIENTAS
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: ğŸ“ REGISTRAR INTERACCIÃ“N DETALLADA
        run: |
          USUARIO="${{ github.actor }}"
          EVENTO="${{ github.event_name }}"
          FECHA="$(date)"
          TIMESTAMP="$(date +%s)"
          
          echo "ğŸ¯ Registrando: $USUARIO - $EVENTO"
          
          mkdir -p "data/usuarios/$USUARIO"
          mkdir -p "data/analitica"
          
          if [ "$EVENTO" == "issues" ]; then
            TITULO_ISSUE="${{ github.event.issue.title }}"
            EXTRAS=",\"titulo\":\"$TITULO_ISSUE\",\"tipo\":\"issue\""
          elif [ "$EVENTO" == "pull_request" ]; then
            TITULO_PR="${{ github.event.pull_request.title }}"
            EXTRAS=",\"titulo\":\"$TITULO_PR\",\"tipo\":\"pr\""
          elif [ "$EVENTO" == "push" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message || 'Sin mensaje' }}"
            COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/"/\\"/g')
            EXTRAS=",\"commit\":\"$COMMIT_MSG_ESCAPED\",\"tipo\":\"push\""
          else
            EXTRAS=",\"tipo\":\"$EVENTO\""
          fi
          
          echo "{\"usuario\":\"$USUARIO\",\"evento\":\"$EVENTO\",\"timestamp\":$TIMESTAMP,\"fecha\":\"$FECHA\"$EXTRAS}" >> "data/analitica/accesos.jsonl"
          echo "{\"evento\":\"$EVENTO\",\"timestamp\":$TIMESTAMP,\"fecha\":\"$FECHA\"$EXTRAS}" >> "data/usuarios/$USUARIO/historial.jsonl"
          
          echo "âœ… Registro completado"

      - name: ğŸ“Š ACTUALIZAR DASHBOARD
        run: |
          if [ -f "data/analitica/accesos.jsonl" ]; then
            TOTAL_EVENTOS=$(cat data/analitica/accesos.jsonl | wc -l)
            USUARIOS_UNICOS=$(cat data/analitica/accesos.jsonl | jq -r '.usuario' | sort | uniq | wc -l)
          else
            TOTAL_EVENTOS=0
            USUARIOS_UNICOS=0
          fi
          
          # Crear dashboard simple
          echo "# ğŸ“Š DASHBOARD IZA" > data/dashboard.md
          echo "" >> data/dashboard.md
          echo "## ğŸ“ˆ ESTADÃSTICAS" >> data/dashboard.md
          echo "- **ğŸ‘¥ Usuarios Ãºnicos:** $USUARIOS_UNICOS" >> data/dashboard.md
          echo "- **ğŸ“Š Total interacciones:** $TOTAL_EVENTOS" >> data/dashboard.md
          echo "- **ğŸ•’ ActualizaciÃ³n:** $(date)" >> data/dashboard.md
          echo "" >> data/dashboard.md
          echo "## ğŸ¯ OBJETIVOS" >> data/dashboard.md
          echo "- [ ] 5 usuarios Ãºnicos" >> data/dashboard.md
          echo "- [ ] 20 interacciones" >> data/dashboard.md
          
          echo "âœ… Dashboard actualizado"

      - name: ğŸ“¤ GUARDAR TODO
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add data/
          git commit -m "ğŸ‘ï¸ Tracking: ${{ github.actor }} - ${{ github.event_name }}" || exit 0
          git push || exit 0
