name: "ğŸ‘ï¸ Tracking IZA - Mapa de Comunidad"

on:
  watch:                    # Cuando alguien da STAR
  fork:                     # Cuando alguien hace FORK  
  issues:
    types: [opened, closed] # Cuando abren/cierran ISSUES
  pull_request:
    types: [opened, closed] # Cuando hacen PULL REQUESTS

permissions:
  contents: write

jobs:
  mapear-comunidad:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ BAJAR CÃ“DIGO
        uses: actions/checkout@v3

      - name: ğŸ“ REGISTRAR INTERACCIÃ“N
        run: |
          # Datos bÃ¡sicos
          USUARIO="${{ github.actor }}"
          EVENTO="${{ github.event_name }}"
          FECHA="$(date)"
          TIMESTAMP="$(date +%s)"
          
          echo "ğŸ¯ Registrando: $USUARIO - $EVENTO"
          
          # Crear carpetas si no existen
          mkdir -p "data/usuarios/$USUARIO"
          mkdir -p "data/analitica"
          
          # Registrar en analÃ­tica general
          echo "{\"usuario\":\"$USUARIO\",\"evento\":\"$EVENTO\",\"timestamp\":$TIMESTAMP,\"fecha\":\"$FECHA\"}" >> "data/analitica/accesos.jsonl"
          
          # Registrar en historial personal
          echo "{\"evento\":\"$EVENTO\",\"timestamp\":$TIMESTAMP,\"fecha\":\"$FECHA\"}" >> "data/usuarios/$USUARIO/historial.jsonl"
          
          echo "âœ… Registro completado para: $USUARIO"

      - name: ğŸ“Š ACTUALIZAR MÃ‰TRICAS
        run: |
          # Contar usuarios Ãºnicos
          USUARIOS_UNICOS=$(cat data/analitica/accesos.jsonl | jq -r '.usuario' | sort | uniq | wc -l)
          TOTAL_EVENTOS=$(cat data/analitica/accesos.jsonl | wc -l)
          
          echo "ğŸ“ˆ MÃ©tricas actualizadas:"
          echo "   ğŸ‘¥ Usuarios Ãºnicos: $USUARIOS_UNICOS"
          echo "   ğŸ“Š Total eventos: $TOTAL_EVENTOS"

      - name: ğŸ“¤ GUARDAR TODO
        run: |
          git config --local user.email "tracking@iza.com"
          git config --local user.name "IZA Tracking System"
          git add data/
          git commit -m "ğŸ‘ï¸ Tracking: ${{ github.actor }} - ${{ github.event_name }}"
          git push
